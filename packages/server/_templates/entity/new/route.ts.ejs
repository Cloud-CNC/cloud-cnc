---
to: src/routes/<%- h.changeCase.param(h.inflection.singularize(name)) %>.ts
---
/**
 * @fileoverview <%- h.changeCase.sentence(h.inflection.singularize(name)) %> routes
 */

//Imports
import Router from '@koa/router';
import checkPermission from '@/middleware/permission';
<% if (entity.operations.find(operation => ['create', 'update'].includes(operation.type))) { -%>
import validate from '@/middleware/validate';
<% } -%>
import {
<% for (const [operation, separator] of h.list(entity.operations, ',')) { -%>
  <%- operation.name %><%- separator %>
<% } -%>
} from '@/controllers/<%- h.changeCase.param(h.inflection.singularize(name)) %>';
import {<%- h.changeCase.pascal(h.inflection.singularize(name), false) %>Schema} from '@/models/<%- h.changeCase.param(h.inflection.singularize(name)) %>';

//Router setup
const router = new Router();

//Register routes
router
<% for (const [operation, operationSeparator] of h.list(entity.operations, '', ';')) { -%>
  /**
<%- h.multiline(operation.description, 3) %>
   */
  .<%- operation.method %>('<%- operation.path %>', checkPermission('<%- operation.permission %>'), <% if (['create', 'update'].includes(operation.type)) { %>validate(<%- h.changeCase.pascal(h.inflection.singularize(name), false) %>Schema, [<% for (const [field, fieldSeparator] of h.list(operation.requestFields, ', ')) { %>'<%- field.name %>'<%- fieldSeparator %><% } %>]), <% } %>async ctx =>
  {
<% switch (operation.type) { case 'all': -%>
    //Get all <%- h.changeCase.no(h.inflection.pluralize(name)) %>
    <% if (operation.responseFields.length > 0) { %>const <%- h.changeCase.camel(h.inflection.pluralize(name)) %> = <% } %>await <%- operation.name %>();

<% if (operation.responseFields.length > 0) { -%>
    //Return the <%- h.changeCase.no(h.inflection.pluralize(name)) %>
    ctx.response.body = <%- h.changeCase.camel(h.inflection.pluralize(name)) %>;
<% } else { -%>
    //Return nothing
    ctx.response.body = null;
<% } break; case 'create': -%>
    //Create the <%- h.changeCase.no(h.inflection.singularize(name)) %>
    <% if (operation.responseFields.length > 0) { %>const <%- h.changeCase.camel(h.inflection.singularize(name)) %> = <% } %>await <%- operation.name %>(ctx.request.body);

<% if (operation.responseFields.length > 0) { -%>
    //Return the <%- h.changeCase.no(h.inflection.singularize(name)) %>
    ctx.response.body = <%- h.changeCase.camel(h.inflection.singularize(name)) %>;
<% } else { -%>
    //Return nothing
    ctx.response.body = null;
<% } break; case 'get': -%>
    try
    {
      //Get the <%- h.changeCase.no(h.inflection.singularize(name)) %>
      <% if (operation.responseFields.length > 0) { %>const <%- h.changeCase.camel(h.inflection.singularize(name)) %> = <% } %>await <%- operation.name %>(<% for (const [parameter, parameterSeparator] of h.list(operation.parameters, ',')) { %>ctx.params.<%- parameter.name %>!<%- parameterSeparator %><% } %>);

<% if (operation.responseFields.length > 0) { -%>
      //Return the <%- h.changeCase.no(h.inflection.singularize(name)) %>
      ctx.response.body = <%- h.changeCase.camel(h.inflection.singularize(name)) %>;
<% } else { -%>
      //Return nothing
      ctx.response.body = null;
<% } -%>
    }
    catch (error)
    {
      //Log
      ctx.log.error(error);

      //Reject
      ctx.throw({
        error: {
          name: 'Invalid <%- h.changeCase.no(h.inflection.singularize(name)) %>!',
          description: error
        }
      }, 400);
    }
<% break; case 'update': -%>
    try
    {
      //Update the <%- h.changeCase.no(h.inflection.singularize(name)) %>
      <% if (operation.responseFields.length > 0) { %>const <%- h.changeCase.camel(h.inflection.singularize(name)) %> = <% } %>await <%- operation.name %>(<% for (const [parameter, parameterSeparator] of h.list(operation.parameters, ',')) { %>ctx.params.<%- parameter.name %>!<%- parameterSeparator %><% } %>, ctx.request.body);

<% if (operation.responseFields.length > 0) { -%>
      //Return the <%- h.changeCase.no(h.inflection.singularize(name)) %>
      ctx.response.body = <%- h.changeCase.camel(h.inflection.singularize(name)) %>;
<% } else { -%>
      //Return nothing
      ctx.response.body = null;
<% } -%>
    }
    catch (error)
    {
      //Log
      ctx.log.error(error);

      //Reject
      ctx.throw({
        error: {
          name: 'Invalid <%- h.changeCase.no(h.inflection.singularize(name)) %>!',
          description: error
        }
      }, 400);
    }
<% break; case 'delete': -%>
    try
    {
      //Delete the <%- h.changeCase.no(h.inflection.singularize(name)) %>
      <% if (operation.responseFields.length > 0) { %>const <%- h.changeCase.camel(h.inflection.singularize(name)) %> = <% } %>await <%- operation.name %>(<% for (const [parameter, parameterSeparator] of h.list(operation.parameters, ',')) { %>ctx.params.<%- parameter.name %>!<%- parameterSeparator %><% } %>);

<% if (operation.responseFields.length > 0) { -%>
      //Return the <%- h.changeCase.no(h.inflection.singularize(name)) %>
      ctx.response.body = <%- h.changeCase.camel(h.inflection.singularize(name)) %>;
<% } else { -%>
      //Return nothing
      ctx.response.body = null;
<% } -%>
    }
    catch (error)
    {
      //Log
      ctx.log.error(error);

      //Reject
      ctx.throw({
        error: {
          name: 'Invalid <%- h.changeCase.no(h.inflection.singularize(name)) %>!',
          description: error
        }
      }, 400);
    }
<% break; default: -%>
    //TODO: fully invoke controller
    await <%- operation.name %>();
<% break; } -%>
  })<%- operationSeparator %>

<% } -%>
//Export
export default router;